<%- include('../layouts/userLayouts/header') %>
<%- include('../layouts/userLayouts/navbar') %>

<!--End Mobile Menu-->

<!--Body Content-->
<div id="page-content">
    <!--Page Title-->
    <div class="page section-header text-center">
        <div class="page-title">
            <div class="wrapper">
                <h1 class="page-width" style="color: black;">Profile</h1>
            </div>
        </div>
    </div>
    <!--End Page Title-->

    <section style="padding-top: 150px; padding-bottom: 150px; background-color: #f4f4f9;">
        <div style="max-width: 1800px; margin: 0 auto;">
            <div style="display: flex;">
                <div style="flex: 0 0 33.33%; padding: 15px; max-width: 350px;">
                    <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                        <ul style="list-style-type: none; padding: 0; margin: 0;">
                            <li>
                                <a style="display: block; padding: 20px; font-size: 18px; text-decoration: none; color: black; background-color: grey; border: 1px solid #dee2e6; border-radius: 5px;" 
                                   id="profile-tab" href="/profile">
                                    <i class="fi-rs-settings-sliders" style="margin-right: 10px;"></i>Profile
                                </a>
                            </li>
                            <li>
                                <a style="display: block; padding: 20px; font-size: 18px; text-decoration: none; color: black; background-color:grey; border: 1px solid #dee2e6; border-radius: 5px;" 
                                   id="orders-tab" href="/orders">
                                    <i class="fi-rs-shopping-bag" style="margin-right: 10px;"></i>Orders
                                </a>
                            </li>
                            <li>
                                <a style="display: block; padding: 20px; font-size: 18px; text-decoration: none; color: black; background-color:grey; border: 1px solid #dee2e6; border-radius: 5px;" 
                                   id="address-tab" href="/address">
                                    <i class="fi-rs-marker" style="margin-right: 10px;"></i>My Address
                                </a>
                            </li>
                            <li>
                                <a style="display: block; padding: 20px; font-size: 18px; text-decoration: none; color: black; background-color:grey; border: 1px solid #dee2e6; border-radius: 5px;" 
                                   id="edit-profile-tab" href="/editProfile">
                                    <i class="fi-rs-user" style="margin-right: 10px;"></i>Edit Profile
                                </a>
                            </li>
                            <li>
                                <a style="display: block; padding: 20px; font-size: 18px; text-decoration: none; color: black; background-color: grey; border: 1px solid #dee2e6; border-radius: 5px;" 
                                   href="/logout">
                                    <i class="fi-rs-sign-out" style="margin-right: 10px;"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- order list start -->
                <div class="card-body" style="color: black; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                    <article class="itemlist">
                        <table style="width: 100%; border-collapse: collapse; color: black;">
                            <thead>
                                <tr>
                                    <th style="width: 5%; border: 1px solid #ccc; padding: 8px; text-align: center; background-color: black; color: white;">Index</th>
                                    <th style="width: 15%; border: 1px solid #ccc; padding: 8px; text-align: center; background-color: black; color: white;">OrderId</th>
                                    <th style="width: 20%; border: 1px solid #ccc; padding: 8px; text-align: center; background-color: black; color: white;">Status</th>
                                    <th style="width: 15%; border: 1px solid #ccc; padding: 8px; text-align: center; background-color: black; color: white;">Order Date</th>
                                    <th style="width: 25%; border: 1px solid #ccc; padding: 8px; text-align: center; background-color: black; color: white;">Shipping Address</th>
                                    <th style="width: 10%; border: 1px solid #ccc; padding: 8px; text-align: center; background-color: black; color: white;">Payment Method</th>
                                    <th style="width: 10%; border: 1px solid #ccc; padding: 8px; text-align: center; background-color: black; color: white;">Total Amount</th>
                                    <th style="width: 10%; border: 1px solid #ccc; padding: 8px; text-align: center; background-color: black; color: white;">View Order</th>
                                    <th style="width: 10%; border: 1px solid #ccc; padding: 8px; text-align: center; background-color: black; color: white;">Invoice</th>
                                    <th style="width: 10%; border: 1px solid #ccc; padding: 8px; text-align: center; background-color: black; color: white;"> Payment</th>


                                </tr>
                            </thead>
                            <tbody>
                                <% orderData.forEach((order, index) => { %>
                                    <tr class="align-items-center mb-3" style="transition: background-color 0.3s;">
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox">
                                            </div>
                                            <span><%= index + 1 %></span>
                                        </td>
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <span><%= order._id %></span>
                                        </td>
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <h6 class="mb-0"><%= order.orderStatus %></h6>
                                        </td>
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <span><%= order.orderDate %></span>
                                        </td>
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <span><%= order.shippingAddress.address %></span>,
                                            <span><%= order.shippingAddress.district %></span>,
                                            <span><%= order.shippingAddress.state %></span>,
                                            <span><%= order.shippingAddress.pincode %></span>,
                                            <span><%= order.shippingAddress.landMark %></span>,
                                            <span><%= order.shippingAddress.phone %></span>
                                        </td>
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <span><%= order.paymentMethod %></span>
                                        </td>
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <span><%= order.grandTotal %></span>
                                        </td>
                                       <td style="border: 1px solid #ccc; text-align: center;">
                                         <a href="/orderDetails?id=<%= order._id %>" style="display: inline-block; background-color: black; color: white; padding: 8px 12px; border-radius: 5px; text-decoration: none;">Order Details</a>
                                       </td>
                                       
                                       <% if(order.orderStatus==="delivered" || order.orderStatus==="return"){ %>
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <a href="/invoice?orderId=<%= order._id %>" style="display: inline-block; background-color: black; color: white; padding: 15px 12px; border-radius: 5px; text-decoration: none;">Invoice</a>
                                           </td>
                                      <% }else{ %>
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <a href="" style="display: inline-block; background-color: black; color: white; padding: 8px 12px; border-radius: 5px; text-decoration: none;"> No Invoice</a>
                                           </td>
                                     <% } %>
                                      <% if(order.paymentMethod==="razorPay" &&  order.paymentStatus==="pending"){ %>
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <a onclick="paymentRetry('<%= order._id %>', '<%= order.grandTotal %>')" 
                                               style="display: inline-block; background-color: black; color: white; padding: 12px 15px; border-radius: 5px; text-decoration: none;">
                                               Retry Payment
                                            </a>
                                        </td>
                                        
                                      <% }else{ %>
                                        <td style="border: 1px solid #ccc; text-align: center;">
                                            <a 
                                               style="display: inline-block; background-color: black; color: white; padding: 18px 15px; border-radius: 5px; text-decoration: none;">
                                               Paid
                                            </a>
                                        </td>
                                     <% } %>
                                       

                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </article>

                    <!-- Pagination area -->
                    <div class="pagination-area mt-30" style="margin-top: 20px; text-align: left;">
                        <nav aria-label="Page navigation example">
                            <ul class="pagination" style="list-style-type: none; padding: 0; display: flex; align-items: center; justify-content: flex-start;">
                                <% if (currentPage > 1) { %>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<%= currentPage - 1 %>" style="padding: 12px 16px; border: 1px solid black; border-radius: 5px; color: black; font-size: 18px; display: flex; align-items: center; justify-content: center; width: 40px; background-color: white;">&lt;</a>
                                    </li>
                                <% } %>
                                <% for (let i = 1; i <= totalPages; i++) { %>
                                    <li class="page-item" style="margin-right: 5px;">
                                        <a class="page-link" href="?page=<%= i %>" style="padding: 12px 16px; border: 1px solid black; border-radius: 5px; color: <%= currentPage === i ? 'white' : 'black' %>; background-color: <%= currentPage === i ? 'black' : 'white' %>; font-size: 18px; display: flex; align-items: center; justify-content: center; width: 40px; text-align: center;"><%= i %></a>
                                    </li>
                                <% } %>
                                <% if (currentPage < totalPages) { %>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<%= currentPage + 1 %>" style="padding: 12px 16px; border: 1px solid black; border-radius: 5px; color: black; font-size: 18px; display: flex; align-items: center; justify-content: center; width: 40px; background-color: white;">&gt;</a>
                                    </li>
                                <% } %>
                            </ul>
                        </nav>
                    </div>
                    
                    
                    
                    
                    
                    
                </div>
    





    </section>
      
    



        <!-- Code by chatgpt end-->



    <!--End Body Content-->
    
    <!--Footer-->
    <footer id="footer">
        <div class="newsletter-section">
            <div class="container">
                <div class="row">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-7 w-100 d-flex justify-content-start align-items-center">
                            <div class="display-table">
                                <div class="display-table-cell footer-newsletter">
                                    <div class="section-header text-center">
                                        <label class="h2"><span>sign up for </span>newsletter</label>
                                    </div>
                                    <form action="#" method="post">
                                        <div class="input-group">
                                            <input type="email" class="input-group__field newsletter__input" name="EMAIL" value="" placeholder="Email address" required="">
                                            <span class="input-group__btn">
                                                <button type="submit" class="btn newsletter__submit" name="commit" id="Subscribe"><span class="newsletter__submit-text--large">Subscribe</span></button>
                                            </span>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-sm-12 col-md-12 col-lg-5 d-flex justify-content-end align-items-center">
                            <div class="footer-social">
                                <ul class="list--inline site-footer__social-icons social-icons">
                                    <li><a class="social-icons__link" href="#" target="_blank" title="Belle Multipurpose Bootstrap 4 Template on Facebook"><i class="icon icon-facebook"></i></a></li>
                                    <li><a class="social-icons__link" href="#" target="_blank" title="Belle Multipurpose Bootstrap 4 Template on Twitter"><i class="icon icon-twitter"></i> <span class="icon__fallback-text">Twitter</span></a></li>
                                    <li><a class="social-icons__link" href="#" target="_blank" title="Belle Multipurpose Bootstrap 4 Template on Pinterest"><i class="icon icon-pinterest"></i> <span class="icon__fallback-text">Pinterest</span></a></li>
                                    <li><a class="social-icons__link" href="#" target="_blank" title="Belle Multipurpose Bootstrap 4 Template on Instagram"><i class="icon icon-instagram"></i> <span class="icon__fallback-text">Instagram</span></a></li>
                                    <li><a class="social-icons__link" href="#" target="_blank" title="Belle Multipurpose Bootstrap 4 Template on Tumblr"><i class="icon icon-tumblr-alt"></i> <span class="icon__fallback-text">Tumblr</span></a></li>
                                    <li><a class="social-icons__link" href="#" target="_blank" title="Belle Multipurpose Bootstrap 4 Template on YouTube"><i class="icon icon-youtube"></i> <span class="icon__fallback-text">YouTube</span></a></li>
                                    <li><a class="social-icons__link" href="#" target="_blank" title="Belle Multipurpose Bootstrap 4 Template on Vimeo"><i class="icon icon-vimeo-alt"></i> <span class="icon__fallback-text">Vimeo</span></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
            </div>    
        </div>
        <div class="site-footer">
        	<div class="container">
     			<!--Footer Links-->
            	<div class="footer-top">
                	<div class="row">
                    	<div class="col-12 col-sm-12 col-md-3 col-lg-3 footer-links">
                        	<h4 class="h4">Quick Shop</h4>
                            <ul>
                            	<li><a href="#">Women</a></li>
                                <li><a href="#">Men</a></li>
                                <li><a href="#">Kids</a></li>
                                <li><a href="#">Sportswear</a></li>
                                <li><a href="#">Sale</a></li>
                            </ul>
                        </div>
                        <div class="col-12 col-sm-12 col-md-3 col-lg-3 footer-links">
                        	<h4 class="h4">Informations</h4>
                            <ul>
                            	<li><a href="#">About us</a></li>
                                <li><a href="#">Careers</a></li>
                                <li><a href="#">Privacy policy</a></li>
                                <li><a href="#">Terms &amp; condition</a></li>
                                <li><a href="#">My Account</a></li>
                            </ul>
                        </div>
                        <div class="col-12 col-sm-12 col-md-3 col-lg-3 footer-links">
                        	<h4 class="h4">Customer Services</h4>
                            <ul>
                            	<li><a href="#">Request Personal Data</a></li>
                                <li><a href="#">FAQ's</a></li>
                                <li><a href="#">Contact Us</a></li>
                                <li><a href="#">Orders and Returns</a></li>
                                <li><a href="#">Support Center</a></li>
                            </ul>
                        </div>
                        <div class="col-12 col-sm-12 col-md-3 col-lg-3 contact-box">
                        	<h4 class="h4">Contact Us</h4>
                            <ul class="addressFooter">
                            	<li><i class="icon anm anm-map-marker-al"></i><p>55 Gallaxy Enque,<br>2568 steet, 23568 NY</p></li>
                                <li class="phone"><i class="icon anm anm-phone-s"></i><p>(440) 000 000 0000</p></li>
                                <li class="email"><i class="icon anm anm-envelope-l"></i><p>sales@yousite.com</p></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!--End Footer Links-->
                <hr>
                <div class="footer-bottom">
                	<div class="row">
                    	<!--Footer Copyright-->
	                	<div class="col-12 col-sm-12 col-md-6 col-lg-6 order-1 order-md-0 order-lg-0 order-sm-1 copyright text-sm-center text-md-left text-lg-left"><span></span> <a href="templateshub.net">Templates Hub</a></div>
                        <!--End Footer Copyright-->
                        <!--Footer Payment Icon-->
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6 order-0 order-md-1 order-lg-1 order-sm-0 payment-icons text-right text-md-center">
                        	<ul class="payment-icons list--inline">
                        		<li><i class="icon fa fa-cc-visa" aria-hidden="true"></i></li>
                                <li><i class="icon fa fa-cc-mastercard" aria-hidden="true"></i></li>
                                <li><i class="icon fa fa-cc-discover" aria-hidden="true"></i></li>
                                <li><i class="icon fa fa-cc-paypal" aria-hidden="true"></i></li>
                                <li><i class="icon fa fa-cc-amex" aria-hidden="true"></i></li>
                                <li><i class="icon fa fa-credit-card" aria-hidden="true"></i></li>
                            </ul>
                        </div>
                        <!--End Footer Payment Icon-->
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!--End Footer-->
    <!--Scoll Top-->
    <span id="site-scroll"><i class="icon anm anm-angle-up-r"></i></span>
    <!--End Scoll Top-->
    
     <!-- Including Jquery -->
     <script src="assets/js/vendor/jquery-3.3.1.min.js"></script>
     <script src="assets/js/vendor/jquery.cookie.js"></script>
     <script src="assets/js/vendor/modernizr-3.6.0.min.js"></script>
     <script src="assets/js/vendor/wow.min.js"></script>
     <!-- Including Javascript -->
     <script src="assets/js/bootstrap.min.js"></script>
     <script src="assets/js/plugins.js"></script>
     <script src="assets/js/popper.min.js"></script>
     <script src="assets/js/lazysizes.js"></script>
     <script src="assets/js/main.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
     <script src="/adminAssets/js/vendors/bootstrap.bundle.min.js"></script>


</div>
</body>


<script>
    function paymentRetry(orderId,finalAmount) {
       
     
      fetch('/retryPayment', {
      method: "POST",
      headers: {
          'Content-Type': "application/json"
      },
      body: JSON.stringify({ orderId:orderId,finalAmount: finalAmount})
  })
  .then(response => {
      
      if (!response.ok) {
          throw new Error('Network response was not ok');
      }
      return response.json();
  })
  .then(data => {
  
  
       
    if (data.success ) {
      const order = data.order;
      const razorPayKeyId = data.razorPayKeyId;
      const orderId=data.orderId
  
      const options = {
          key: razorPayKeyId, 
          amount: order.amount, 
          currency: order.currency,
          name: "SafeCap", 
          description: "Order payment", 
          order_id: order.id, 
          handler: async function (response) {
              try {
                  const verifyResponse = await fetch('/verifyPayment', {
                      method: "POST",
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                          razorpay_order_id: response.razorpay_order_id,
                          razorpay_payment_id: response.razorpay_payment_id,
                          razorpay_signature: response.razorpay_signature,
                          orderId:orderId
                      }),
                  });
  
                  const verifyResult = await verifyResponse.json();
              
  
                  if (verifyResult.success) {
                      console.log("arun hlo")
                      Swal.fire({
                          icon: 'success',
                          title: 'Payment Successful',
                          text: 'Your payment has been verified successfully.',
                      });
                      setTimeout(() => {
                          window.location.replace('/');
                         }, 3000);
                         return
                  } else {
                      Swal.fire({
                          icon: 'error',
                          title: 'Verification Failed',
                          text: verifyResult.message || 'Payment verification failed.',
                      });
                  }
  
                  window.location.href('/')
              } catch (error) {
                  console.error('Error verifying payment:', error);
                  Swal.fire({
                      icon: 'error',
                      title: 'Error',
                      text: 'An error occurred during payment verification. Please try again.',
                  });
              }
          },
          prefill: {
              name: "Customer Name", 
              email: "customer@example.com", 
              contact: "9999999999", 
          },
          theme: { color: "#3399cc" }, 
      };
  
      // Initialize and open Razorpay payment gateway
      const rzp = new Razorpay(options);
      rzp.open();
      rzp.on('payment.failed', function (response) {
          const orderId=data.orderId
  
      fetch('/paymentFailure', {
          method: "POST",
          headers: {
              'Content-Type': "application/json"
          },
          body: JSON.stringify({ orderId: orderId })
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          return response.json();
      })
      .then(data => {
          if (data.success) {
              console.log("gichu");
              // Redirect the user to the failure page
              window.location.href = '/displayFailure';
          }
      })
      .catch(error => {
          console.error('Error:', error);
          window.location.href = '/displayFailure';
      });
  });
  
    }
  
    })
    
  
    
  }
  </script>

</html>